<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transcript</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; vertical-align: top; }
    audio { width: 200px; }
    pre { white-space: pre-wrap; background: #f9f9f9; padding: 1rem; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>📝 Transcript</h1>
  <p><a href="/dashboard/index.html">⬅️ Back to recordings</a></p>
  <div>
    <h2>Summary</h2>
    <pre id="summary">Loading...</pre>
    <button id="summarize">📝 Summarize</button>
    <button id="label">🔖 Label Speakers</button>
  </div>
  <table id="segments">
    <thead>
      <tr>
        <th>Start</th>
        <th>End</th>
        <th>Speaker</th>
        <th>Transcript</th>
        <th>Audio</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    function getId() {
      return new URLSearchParams(location.search).get('id');
    }

    async function loadSegments() {
      const id = getId();
      const res = await fetch(`/api/segments/${id}`);
      const segs = await res.json();
      const tbody = document.querySelector('#segments tbody');
      tbody.innerHTML = '';
      segs.forEach(seg => {
        const file = seg.embedding_path ? seg.embedding_path.split('/').pop() : '';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${seg.start_time.toFixed(1)}</td>
          <td>${seg.end_time.toFixed(1)}</td>
          <td>${seg.speaker_label || seg.speaker_id || ''}</td>
          <td>${seg.transcript}</td>
          <td>${file ? `<audio controls src="/segments/${file}"></audio>` : ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function loadSummary() {
      const id = getId();
      const res = await fetch(`/api/recordings/${id}/summary`);
      const pre = document.getElementById('summary');
      if (res.ok) {
        const data = await res.json();
        pre.textContent = data.summary;
      } else {
        pre.textContent = 'No summary available';
      }
    }

    document.getElementById('summarize').addEventListener('click', async () => {
      const id = getId();
      const res = await fetch(`/api/recordings/${id}/summarize`, { method: 'POST' });
      if (res.ok) {
        alert('Summarization started');
        loadSummary();
      } else {
        alert('Failed to summarize');
      }
    });

    document.getElementById('label').addEventListener('click', async () => {
      const id = getId();
      const res = await fetch(`/api/recordings/${id}/label_speakers`, { method: 'POST' });
      if (res.ok) {
        alert('Labeling started');
        loadSegments();
      } else {
        alert('Failed to label speakers');
      }
    });

    (async function init() {
      await loadSummary();
      await loadSegments();
    })();
  </script>
</body>
</html>
